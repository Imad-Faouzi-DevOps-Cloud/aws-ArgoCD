# Pipeline CI/CD Multi-environnement amÃ©liorÃ©
# Build Docker image â†’ Push ECR â†’ Deploy via ArgoCD
# Auto-deploy DEV, validation manuelle STAGING/PROD

name: Build and Deploy to EKS via ArgoCD

on:
  push:
    branches:
      - dev
      - staging
      - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: eu-north-1
  ECR_REGISTRY: 136312924616.dkr.ecr.eu-north-1.amazonaws.com
  ECR_REPOSITORY: my-app

jobs:
  # JOB 1: Build et Push Docker
  build:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.image.outputs.tag }}
      environment: ${{ steps.env.outputs.name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "name=prod" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            echo "name=staging" >> $GITHUB_OUTPUT
          else
            echo "name=dev" >> $GITHUB_OUTPUT
          fi
      
      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::136312924616:role/github-actions-ecr2
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Build, tag and push Docker image
        id: image
        run: |
          IMAGE_TAG=${{ steps.env.outputs.name }}-${{ github.sha }}
          IMAGE_URI=${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${IMAGE_TAG}
          
          echo "Building image: ${IMAGE_URI}"
          docker build -t ${IMAGE_URI} -f my-app/Dockerfile my-app/
          docker push ${IMAGE_URI}
          
          echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "âœ… Image pushed: ${IMAGE_URI}"

  # JOB 2: Tests automatisÃ©s
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Validate Kubernetes manifests
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/
          kustomize build my-app/overlays/${{ needs.build.outputs.environment }}
      
      - name: Security scan (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ needs.build.outputs.image_tag }}
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'

  # JOB 3: Deploy DEV (automatique)
  deploy-dev:
    name: Deploy to DEV
    runs-on: ubuntu-latest
    needs: [build, test]
    if: github.ref == 'refs/heads/dev'
    environment: dev
    
    steps:
      - name: Install ArgoCD CLI
        run: |
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x argocd
          sudo mv argocd /usr/local/bin/
      
      - name: Login to ArgoCD
        env:
          ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
          ARGOCD_USERNAME: ${{ secrets.ARGOCD_USERNAME }}
          ARGOCD_PASSWORD: ${{ secrets.ARGOCD_PASSWORD }}
        run: |
          argocd login $ARGOCD_SERVER --username $ARGOCD_USERNAME --password $ARGOCD_PASSWORD --insecure
      
      - name: Sync ArgoCD Application (DEV)
        run: |
          argocd app set my-app-dev --parameter image.tag=${{ needs.build.outputs.image_tag }}
          argocd app sync my-app-dev
          argocd app wait my-app-dev --timeout 300
          echo "âœ… DEV deployment complete!"

  # JOB 4: Deploy STAGING (validation manuelle)
  deploy-staging:
    name: Deploy to STAGING
    runs-on: ubuntu-latest
    needs: [build, test]
    if: github.ref == 'refs/heads/staging'
    environment: 
      name: staging
      # NÃ©cessite approbation manuelle dans GitHub
    
    steps:
      - name: Install ArgoCD CLI
        run: |
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x argocd
          sudo mv argocd /usr/local/bin/
      
      - name: Login to ArgoCD
        env:
          ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
          ARGOCD_USERNAME: ${{ secrets.ARGOCD_USERNAME }}
          ARGOCD_PASSWORD: ${{ secrets.ARGOCD_PASSWORD }}
        run: |
          argocd login $ARGOCD_SERVER --username $ARGOCD_USERNAME --password $ARGOCD_PASSWORD --insecure
      
      - name: Sync ArgoCD Application (STAGING)
        run: |
          argocd app set my-app-staging --parameter image.tag=${{ needs.build.outputs.image_tag }}
          argocd app sync my-app-staging
          argocd app wait my-app-staging --timeout 300
          echo "âœ… STAGING deployment complete!"

  # JOB 5: Deploy PROD (validation manuelle)
  deploy-prod:
    name: Deploy to PRODUCTION
    runs-on: ubuntu-latest
    needs: [build, test]
    if: github.ref == 'refs/heads/main'
    environment: 
      name: production
      # NÃ©cessite approbation manuelle dans GitHub
    
    steps:
      - name: Install ArgoCD CLI
        run: |
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x argocd
          sudo mv argocd /usr/local/bin/
      
      - name: Login to ArgoCD
        env:
          ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
          ARGOCD_USERNAME: ${{ secrets.ARGOCD_USERNAME }}
          ARGOCD_PASSWORD: ${{ secrets.ARGOCD_PASSWORD }}
        run: |
          argocd login $ARGOCD_SERVER --username $ARGOCD_USERNAME --password $ARGOCD_PASSWORD --insecure
      
      - name: Sync ArgoCD Application (PROD)
        run: |
          argocd app set my-app-prod --parameter image.tag=${{ needs.build.outputs.image_tag }}
          argocd app sync my-app-prod
          argocd app wait my-app-prod --timeout 300
          echo "ðŸš€ PRODUCTION deployment complete!"
      
      - name: Post-deployment verification
        run: |
          echo "âœ… Deployment successful"
          echo "ðŸ“Š Image: ${{ needs.build.outputs.image_tag }}"
          # Ajouter health checks ici
